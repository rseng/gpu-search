# https://github.com/tldr-group/taufactor

```console
setup.py:        'Environment :: GPU',
setup.py:        'Environment :: GPU :: NVIDIA CUDA',
docs/installation.md:Before installing taufactor, [download the most recent version of PyTorch](https://pytorch.org/get-started/locally/). Your exact PyTorch configuration will depend on your operating system and GPU availability. Ensure your PyTorch version is `pytorch>=1.0`.
docs/installation.md:For example, for a Linux machine with CUDA GPU
docs/installation.md:conda install pytorch pytorch-cuda=11.7 -c pytorch -c nvidia
docs/installation.md:If running locally, you must adjust `environment.yml` with appropriate CUDA version. Then follow these steps for setup.
tests/environment.yml:    - nvidia
tests/environment.yml:    - pytorch-cuda=11.6
environment.yml:    - nvidia
environment.yml:    - pytorch-cuda=11.6
README.md:For example, for a Linux machine with CUDA GPU
README.md:conda install pytorch pytorch-cuda=11.7 -c pytorch -c nvidia
paper.md:title: "TauFactor 2: A GPU accelerated python tool for microstructural analysis"
paper.md:TauFactor 2 is an open-source, GPU accelerated microstructural analysis tool for extracting metrics from voxel based data, including transport properties such as the touristy factor. Tortuosity factor, $\tau$, is a material parameter that defines the reduction in transport arising from the arrangement of the phases in a multiphase medium (see \autoref{example}). As shown in \autoref{eq:tort}, the effective transport coefficient of a material, $D_{\text{eff}}$, can be calculated from the phases intrinsic transport coefficient, $D$, volume fraction, $\epsilon$, and $\tau$ [@cooper2016taufactor] (note, this value of $\tau$ should not be squared [@tjaden2016origin]).
paper.md:TauFactor 1 [@cooper2016taufactor] provided an open-source MATLAB application for calculating various microstructural metrics, including the touristy factor. However, its implementation as a serial CPU based solver meant that large microstructural dataset could take hours to converge. This made TauFactor 1 unsuitable for use in high-throughput tasks such as materials optimisation. TauFactor 2 provides the necessary efficiency to ensure users can analyse large datasets in reasonable times. The software is built with PyTorch [@pytorch], a commonly used and highly optimised python package for machine learning. The GPU acceleration that has enabled the drastic speed up of neural network training proves equally effective for the task of iteratively solving transport equations, where matrix multiplication and addition are the main operations required. The use of Python and PyTorch ensures broad support and easy installation, as well as the option to run the software on CPU if GPU hardware is not available. The ability to run simulations with just a few lines of code ensures accessibility for researchers from the diverse fields where this software may be of use.
paper.md:The Python implementation is similar to the original TauFactor 1, taking advantage of efficiency gains such as the precalculation of prefactors and the use of over-relaxation. The same convergence criteria are also used, where the vertical flux between each layer is averaged across the planes parallel to the stimulated boundaries. If the percentage error between the minimum and maximum flux is below a given value (default 1\%), this indicates convergence has been reached. Once this is satsfied, an extra 100 iterations are performed to confirm the stability of the system. A notable difference in TauFactor 2 is that flux is calculated for all voxels. This replaces an indexing system in TauFactor 1, which solved only in active voxels. We find that the speed of GPU indexing compared to matrix multiplication makes this trade-off worthwhile. As well as the standard solver for a single transport phase, a multi-phase solver is available, where the tortuosity relates $D_{\text{eff}}$ to the intrinsic diffusion coefficients and volume fractions of the various phases, $p$, as follows:
paper.md:$D_{\text{mean}}$ is a weighted sum of the active phase transport coefficients according to their volume fractions, which gives a transport coefficient equivalent to prismatic blocks of each phase spanning a test volume, in the direction of transport (i.e. perfectly straight transport paths). Periodic boundary conditions can also be used, which replace no-flux boundary conditions at the outer edges of the control volume. Finally, Taufactor 2 also includes an electrode tortuosity factor solver (see [@nguyen2020electrode]). There are also GPU accelerated functions for calculating volume fractions, surface areas, triple phase boundaries and the two-point correlation function. 
paper.md:To compare the performance of TauFactor 2 to other available software, a test volume (500x500x500 = 125,000,000 voxels) was created. One of the phases in this two-phase volume fully percolates in all three directions, while the other phase does not percolate at all. The percolating phase has a volume fraction of exactly 30%. The percolating network is anisotropic in the three directions, leading to different transport metrics. Lastly, the structure is periodic at its boundaries, allowing for the exploration of the impact of periodic transport boundaries. This microstructure is available in the GitHub repository, providing a standard against which new software can also be measured. The speed of five different solvers, namely TauFactor 1 [@cooper2016taufactor], TauFactor 1.9 (an updated version of TauFactor 1, available \href{https://uk.mathworks.com/matlabcentral/fileexchange/57956-taufactor}{here}, that has new solvers such as diffusion impedance and can be called inline as well as from the GUI [@cooper2017simulated]), TauFactor 2 (CPU), TauFactor 2 (GPU), PoreSpy [@gostick2019porespy] and Puma [@ferguson2018puma], are shown in \autoref{speeds}. To check the accuracy of the calculated tortuosity factors, we overconverge TauFactor 2 to give a ‘true value’ in each direction. Using default convergence criteria, all five solvers are within 0.5% of the true values other then PuMa’s explicit jump solver (5% error), which is thus excluded (note it was still >2x slower than TF2). For this analysis we used a NVIDIA A6000 48GB GPU and AMD Ryzen Threadripper 3970X Gen3 32 Core TRX4 CPU. TauFactor 2 is over 10 times faster than the next best solver, TauFactor 1.9, and over 100 times faster than the original TauFactor 1 solver.
taufactor/taufactor.py:    def __init__(self, img, bc=(-0.5, 0.5), D_0=1, device=torch.device('cuda')):
taufactor/taufactor.py:        :param device: pytorch device, can be cuda or cpu 
taufactor/taufactor.py:        if torch.device(device).type.startswith('cuda') and not torch.cuda.is_available():
taufactor/taufactor.py:                "CUDA not available, defaulting device to cpu. To avoid this warning, explicitly set the device when initialising the solver with device=torch.device('cpu')")
taufactor/taufactor.py:        # save original image in cuda
taufactor/taufactor.py:    def __init__(self, img, bc=(-0.5, 0.5), D_0=1, device=torch.device('cuda:0')):
taufactor/taufactor.py:    def __init__(self, img, cond={1: 1}, bc=(-0.5, 0.5), device=torch.device('cuda:0')):
taufactor/taufactor.py:        if torch.device(device).type.startswith('cuda') and not torch.cuda.is_available():
taufactor/taufactor.py:                "CUDA not available, defaulting device to cpu. To avoid this warning, explicitly set the device when initialising the solver with device=torch.device('cpu')")
taufactor/taufactor.py:        # save original image in cuda
taufactor/taufactor.py:    def __init__(self, img, omega=1e-6, device=torch.device('cuda')):
taufactor/taufactor.py:        if torch.device(device).type.startswith('cuda') and not torch.cuda.is_available():
taufactor/taufactor.py:                "CUDA not available, defaulting device to cpu. To avoid this warning, explicitly set the device when initialising the solver with device=torch.device('cpu')")
taufactor/taufactor.py:        # save original image in cuda

```
